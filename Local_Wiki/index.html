<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Wiki</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #222;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        header {
            background: #fff;
            border-bottom: 1px solid #a2a9b1;
            padding: 0.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0645ad;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        button {
            padding: 0.5rem 1rem;
            border: 1px solid #a2a9b1;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 2px;
            font-size: 0.9rem;
        }

        button:hover {
            background: #e8f4fd;
        }

        .primary-btn {
            background: #0645ad;
            color: white;
            border-color: #0645ad;
        }

        .primary-btn:hover {
            background: #0b0080;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        input[type="text"] {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            font-size: 1rem;
        }

        .content {
            padding: 1rem 2rem;
        }

        .page-title {
            font-size: 2rem;
            border-bottom: 3px solid #a2a9b1;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            color: #000;
        }

        .editor {
            display: none;
        }

        .editor textarea {
            width: 100%;
            min-height: 400px;
            padding: 1rem;
            border: 1px solid #a2a9b1;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        .editor-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        /* IPA Infobox Styles */
        .infobox {
            float: right;
            clear: right;
            margin: 0.5em 0 1em 1em;
            padding: 0.2em;
            width: 22em;
            text-align: center;
            font-size: 88%;
            line-height: 1.5em;
            border: 1px solid #a2a9b1;
            border-collapse: collapse;
            background: #f8f9fa;
        }

        .infobox th {
            background: #f2f2ce;
            padding: 0.4em;
            font-weight: bold;
            border: 1px solid #a2a9b1;
        }

        .infobox td {
            background: #ffffe6;
            padding: 0.4em;
            border: 1px solid #a2a9b1;
        }

        .IPA-symbol {
            font-size: 5em;
            line-height: 1.2em;
            vertical-align: super;
            font-weight: normal;
            font-family: 'Segoe UI', 'DejaVu Sans', 'Lucida Grande', Arial, sans-serif;
        }

        .audio-row {
            background: #f0f8ff !important;
        }

        .audio-button {
            background: #0645ad;
            color: white;
            border: none;
            padding: 0.3em 0.6em;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .audio-button:hover {
            background: #0b0080;
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            .infobox {
                float: none;
                clear: none;
                margin: 0 auto 1em auto;
                width: 100%;
                max-width: 22em;
            }
        }

        /* Wiki content styles */
        .wiki-content h1 { font-size: 1.8rem; margin: 1.5rem 0 1rem; border-bottom: 1px solid #a2a9b1; padding-bottom: 0.3rem; }
        .wiki-content h2 { font-size: 1.5rem; margin: 1.3rem 0 0.8rem; border-bottom: 1px solid #a2a9b1; padding-bottom: 0.2rem; }
        .wiki-content h3 { font-size: 1.3rem; margin: 1.1rem 0 0.6rem; }
        .wiki-content h4 { font-size: 1.1rem; margin: 1rem 0 0.5rem; font-weight: bold; }
        .wiki-content h5 { font-size: 1rem; margin: 0.9rem 0 0.4rem; font-weight: bold; }
        .wiki-content h6 { font-size: 0.9rem; margin: 0.8rem 0 0.3rem; font-weight: bold; }

        .wiki-content p {
            margin-bottom: 1rem;
        }

        .wiki-content ul, .wiki-content ol {
            margin: 1rem 0 1rem 2rem;
        }

        .wiki-content li {
            margin-bottom: 0.3rem;
        }

        .wiki-content blockquote {
            border-left: 4px solid #a2a9b1;
            margin: 1rem 0;
            padding-left: 1rem;
            color: #555;
        }

        .wiki-content code {
            background: #f6f6f6;
            padding: 0.2rem 0.4rem;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .wiki-content pre {
            background: #f6f6f6;
            padding: 1rem;
            border-radius: 2px;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .wiki-content pre code {
            background: none;
            padding: 0;
        }

        .wiki-content a {
            color: #0645ad;
            text-decoration: none;
        }

        .wiki-content a:hover {
            text-decoration: underline;
        }

        .wiki-content a.new {
            color: #ba0000;
        }

        .wiki-content strong {
            font-weight: bold;
        }

        .wiki-content em {
            font-style: italic;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 1rem;
            margin-top: 2rem;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
        }

        .sidebar h3 {
            margin-top: 0;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .page-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .page-list li {
            margin-bottom: 0.3rem;
        }

        .page-list a {
            color: #0645ad;
            text-decoration: none;
        }

        .page-list a:hover {
            text-decoration: underline;
        }

        .help-text {
            background: #f0f8ff;
            border: 1px solid #a2a9b1;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 2px;
            font-size: 0.9rem;
        }

        .help-text h4 {
            margin-top: 0;
            color: #0645ad;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 2rem 0;
        }

        /* Template features table */
        .features-list {
            margin: 1rem 0;
        }

        .features-list ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .features-list li {
            padding: 0.2rem 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">ðŸ“š Local Wiki</div>
                <div class="nav-buttons">
                    <button id="newPageBtn">New Page</button>
                    <button id="editBtn">Edit</button>
                    <button id="deleteBtn">Delete</button>
                    <button id="historyBtn">All Pages</button>
                    <button id="pageHistoryBtn">Page History</button>
                    <button id="helpBtn">Help</button>
                    <button id="exportBtn">Export Data</button>
                    <button id="importBtn">Import Data</button>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search or enter page name...">
                <button id="searchBtn">Go</button>
            </div>
        </header>

        <div class="content">
            <div id="viewer">
                <h1 class="page-title" id="pageTitle">Welcome to Phonetic Wiki</h1>
                <div class="wiki-content" id="pageContent">
                    <div class="empty-state">
                        <p>Welcome to your personal phonetic wiki! This wiki supports Wikipedia-style markup including IPA infoboxes.</p>
                        <p>Click "New Page" to create your first page, or "Help" to learn about the markup syntax.</p>
                    </div>
                </div>
            </div>

            <div id="editor" class="editor">
                <h1 class="page-title" id="editorTitle">Editing Page</h1>
                <textarea id="editorTextarea" placeholder="Enter your wiki content here using Wikipedia markup..."></textarea>
                <div class="editor-buttons">
                    <button id="saveBtn" class="primary-btn">Save Page</button>
                    <button id="cancelBtn">Cancel</button>
                    <button id="previewBtn">Preview</button>
                </div>
            </div>

            <div class="sidebar">
                <h3 id="sidebarTitle">All Pages</h3>
                <ul class="page-list" id="pageList">
                    <li class="empty-state">No pages yet</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        class Wiki {
            constructor() {
                this.currentPage = 'Main Page';
                this.isEditing = false;
                this.initializeElements();
                this.bindEvents();
                this.loadPage(this.currentPage);
                this.updatePageList();
            }
    
            initializeElements() {
                this.viewer = document.getElementById('viewer');
                this.editor = document.getElementById('editor');
                this.pageTitle = document.getElementById('pageTitle');
                this.pageContent = document.getElementById('pageContent');
                this.editorTitle = document.getElementById('editorTitle');
                this.editorTextarea = document.getElementById('editorTextarea');
                this.searchInput = document.getElementById('searchInput');
                this.pageList = document.getElementById('pageList');
                this.sidebarTitle = document.getElementById('sidebarTitle');
            }

            bindEvents() {
                document.getElementById('newPageBtn').addEventListener('click', () => this.newPage());
                document.getElementById('editBtn').addEventListener('click', () => this.editPage());
                document.getElementById('deleteBtn').addEventListener('click', () => this.deletePage());
                document.getElementById('saveBtn').addEventListener('click', () => this.savePage());
                document.getElementById('cancelBtn').addEventListener('click', () => this.cancelEdit());
                document.getElementById('previewBtn').addEventListener('click', () => this.previewPage());
                document.getElementById('searchBtn').addEventListener('click', () => this.searchPage());
                document.getElementById('historyBtn').addEventListener('click', () => this.showAllPages());
                document.getElementById('helpBtn').addEventListener('click', () => this.showHelp());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('importBtn').addEventListener('click', () => this.importData());
                
                this.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.searchPage();
                });

                // Handle internal links
                document.addEventListener('click', (e) => {
                    if (e.target.matches('a[href^="#"]')) {
                        e.preventDefault();
                        const pageName = e.target.getAttribute('href').substring(1);
                        this.loadPage(pageName);
                    }
                });
            }

            getPages() {
                try {
                    const pages = localStorage.getItem('wiki_pages');
                    const result = pages ? JSON.parse(pages) : {};
                    return result;
                } catch (error) {
                    console.error('Error reading from localStorage:', error);
                    return {};
                }
            }

            savePage() {
                const content = this.editorTextarea.value;
                const pages = this.getPages();
                
                pages[this.currentPage] = content;
                localStorage.setItem('wiki_pages', JSON.stringify(pages));
                
                this.isEditing = false;
                this.showViewer();
                this.loadPage(this.currentPage);
                this.updatePageList();
            }

            loadPage(pageName, updateHistory = true) {
                this.currentPage = pageName;
                const pages = this.getPages();
                const content = pages[pageName] || '';
                
                this.pageTitle.textContent = pageName;
                this.searchInput.value = pageName;
                
                if (content) {
                    this.pageContent.innerHTML = this.parseWikiMarkup(content);
                } else if (pageName === 'Main Page') {
                    this.pageContent.innerHTML = `
                        <div class="empty-state">
                            <p>Welcome to your personal phonetic wiki! This wiki supports Wikipedia-style markup including IPA infoboxes.</p>
                            <p>Click "New Page" to create your first page, or "Help" to learn about the markup syntax.</p>
                        </div>
                    `;
                } else {
                    this.pageContent.innerHTML = `
                        <div class="empty-state">
                            <p>Page "${pageName}" does not exist yet.</p>
                            <p><button onclick="wiki.editPage()">Create this page</button></p>
                        </div>
                    `;
                }
                
                this.showViewer();
            }

            editPage() {
                const pages = this.getPages();
                const content = pages[this.currentPage] || '';
                
                this.editorTitle.textContent = `Editing: ${this.currentPage}`;
                this.editorTextarea.value = content;
                this.isEditing = true;
                this.showEditor();
            }

            newPage() {
                const pageName = prompt('Enter the name of the new page:');
                if (pageName && pageName.trim()) {
                    this.loadPage(pageName.trim());
                    this.editPage();
                }
            }

            deletePage() {
                if (['Main Page', 'All Pages', 'Help'].includes(this.currentPage)) {
                    alert('This page cannot be deleted.');
                    return;
                }
                
                const pages = this.getPages();
                if (!pages[this.currentPage]) {
                    alert('This page does not exist.');
                    return;
                }
                
                if (confirm(`Are you sure you want to delete the page "${this.currentPage}"? This action cannot be undone.`)) {
                    delete pages[this.currentPage];
                    localStorage.setItem('wiki_pages', JSON.stringify(pages));
                    this.updatePageList();
                    this.loadPage('Main Page');
                }
            }

            cancelEdit() {
                this.isEditing = false;
                this.showViewer();
            }

            previewPage() {
                const content = this.editorTextarea.value;
                this.pageContent.innerHTML = this.parseWikiMarkup(content);
                
                this.viewer.style.display = 'block';
                this.editor.style.display = 'none';
                
                setTimeout(() => {
                    this.showEditor();
                }, 100);
            }

            searchPage() {
                const pageName = this.searchInput.value.trim();
                if (pageName) {
                    this.loadPage(pageName);
                }
            }

            showViewer() {
                this.viewer.style.display = 'block';
                this.editor.style.display = 'none';
            }

            showEditor() {
                this.viewer.style.display = 'none';
                this.editor.style.display = 'block';
            }

            updatePageList() {
                const pages = this.getPages();
                const pageNames = Object.keys(pages).sort();
                
                if (pageNames.length === 0) {
                    this.pageList.innerHTML = '<li class="empty-state">No pages yet</li>';
                } else {
                    this.pageList.innerHTML = pageNames
                        .map(name => `<li><a href="#${name}">${name}</a></li>`)
                        .join('');
                }
            }

            showAllPages() {
                const pages = this.getPages();
                const pageNames = Object.keys(pages).sort();
                
                let content = '= All Pages =\n\n';
                if (pageNames.length === 0) {
                    content += 'No pages have been created yet.';
                } else {
                    pageNames.forEach(name => {
                        content += `* [[${name}]]\n`;
                    });
                }
                
                this.loadPage('All Pages');
                this.pageContent.innerHTML = this.parseWikiMarkup(content);
            }

            showHelp() {
                const helpContent = `= Wiki Markup Help =

This wiki supports Wikipedia-style markup including IPA infoboxes.

== IPA Infobox ==
Create IPA infoboxes like this:

<code>{{infobox IPA|above=Voiced bilabial plosive|ipa symbol=b|ipa symbol2=bÌ¬|soundfile=voiced-bilabial-plosive.ogg}}</code>

Parameters:
* <code>above</code> - The title/name of the sound
* <code>ipa symbol</code> - Primary IPA symbol (will be large)
* <code>ipa symbol2</code> - Secondary/alternative symbol
* <code>ipa symbol3</code> - Tertiary symbol
* <code>ipa symbol4</code> - Quaternary symbol
* <code>soundfile</code> - Audio filename (creates play button)

<!-- Not how Wikipedia shows features! == Features Template ==
Add phonetic features:

<code>{{features|trill|palatal|voiced|oral|central articulation|pulmonic}}</code> -->

== Headings ==
* <code>= Level 1 =</code>
* <code>== Level 2 ==</code>
* <code>=== Level 3 ===</code>

== Text Formatting ==
* <code>'''bold text'''</code> â†’ '''bold text'''
* <code>''italic text''</code> â†’ ''italic text''

== Lists ==
* <code>* Bullet point</code>
* <code># Numbered list</code>

== Links ==
* <code>[[Page Name]]</code> â†’ Link to another page
* <code>[[Page Name|Display Text]]</code> â†’ Link with custom text

== Example Page ==
<pre>
= Voiced Bilabial Plosive =

{{infobox IPA|above=Voiced bilabial plosive|ipa symbol=b|ipa symbol2=bÌ¬}}

The '''voiced bilabial plosive''' is a consonantal sound.

== Features ==
{{features|plosive|bilabial|voiced|oral|central articulation|pulmonic}}

== Occurrence ==
This sound occurs in many languages including:
* English
* Spanish  
* French

See also: [[Voiceless bilabial plosive]]
</pre>
`;
                
                this.loadPage('Help');
                this.pageContent.innerHTML = this.parseWikiMarkup(helpContent);
            }

            exportData() {
                const pages = this.getPages();
                const dataStr = JSON.stringify(pages, null, 2);
                
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'wiki-backup.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('Wiki data exported!');
            }

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                
                                if (typeof importedData === 'object' && importedData !== null) {
                                    const pageCount = Object.keys(importedData).length;
                                    if (confirm(`Import ${pageCount} pages? This will merge with existing data.`)) {
                                        const currentPages = this.getPages();
                                        const mergedPages = { ...currentPages, ...importedData };
                                        localStorage.setItem('wiki_pages', JSON.stringify(mergedPages));
                                        this.updatePageList();
                                        alert(`Successfully imported ${pageCount} pages!`);
                                        this.loadPage('Main Page');
                                    }
                                } else {
                                    alert('Invalid file format.');
                                }
                            } catch (error) {
                                alert('Error reading file: ' + error.message);
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                
                input.click();
            }

            parseWikiMarkup(text) {
                let html = text;
                
                // Escape HTML first
                html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                // Parse templates first (before other markup)
                html = this.parseTemplates(html);
                
                // Headings
                html = html.replace(/^======\s*(.*?)\s*======$/gm, '<h6>$1</h6>');
                html = html.replace(/^=====\s*(.*?)\s*=====$/gm, '<h5>$1</h5>');
                html = html.replace(/^====\s*(.*?)\s*====$/gm, '<h4>$1</h4>');
                html = html.replace(/^===\s*(.*?)\s*===$/gm, '<h3>$1</h3>');
                html = html.replace(/^==\s*(.*?)\s*==$/gm, '<h2>$1</h2>');
                html = html.replace(/^=\s*(.*?)\s*=$/gm, '<h1>$1</h1>');
                
                // Bold and italic
                html = html.replace(/'''(.*?)'''/g, '<strong>$1</strong>');
                html = html.replace(/''(.*?)''/g, '<em>$1</em>');
                
                // Links
                html = html.replace(/\[\[([^\|\]]+)\|([^\]]+)\]\]/g, (match, page, text) => {
                    const pages = this.getPages();
                    const className = pages[page] ? '' : ' class="new"';
                    return `<a href="#${page}"${className}>${text}</a>`;
                });
                
                html = html.replace(/\[\[([^\]]+)\]\]/g, (match, page) => {
                    const pages = this.getPages();
                    const className = pages[page] ? '' : ' class="new"';
                    return `<a href="#${page}"${className}>${page}</a>`;
                });
                
                // Code blocks
                html = html.replace(/&lt;pre&gt;([\s\S]*?)&lt;\/pre&gt;/g, '<pre><code>$1</code></pre>');
                html = html.replace(/&lt;code&gt;(.*?)&lt;\/code&gt;/g, '<code>$1</code>');
                
                // Lists
                const lines = html.split('\n');
                let inList = false;
                let listType = '';
                let result = [];
                
                for (let line of lines) {
                    const bulletMatch = line.match(/^(\*+)\s*(.*)$/);
                    const numberMatch = line.match(/^(#+)\s*(.*)$/);
                    
                    if (bulletMatch) {
                        const level = bulletMatch[1].length;
                        const content = bulletMatch[2];
                        
                        if (!inList || listType !== 'ul') {
                            if (inList) result.push('</ul>');
                            result.push('<ul>');
                            inList = true;
                            listType = 'ul';
                        }
                        result.push(`<li>${content}</li>`);
                    } else if (numberMatch) {
                        const level = numberMatch[1].length;
                        const content = numberMatch[2];
                        
                        if (!inList || listType !== 'ol') {
                            if (inList) result.push('</ol>');
                            result.push('<ol>');
                            inList = true;
                            listType = 'ol';
                        }
                        result.push(`<li>${content}</li>`);
                    } else {
                        if (inList) {
                            result.push(listType === 'ul' ? '</ul>' : '</ol>');
                            inList = false;
                        }
                        result.push(line);
                    }
                }
                
                if (inList) {
                    result.push(listType === 'ul' ? '</ul>' : '</ol>');
                }
                
                html = result.join('\n');
                
                // Paragraphs
                html = html.replace(/\n\s*\n/g, '</p><p>');
                html = '<p>' + html + '</p>';
                
                // Clean up empty paragraphs and fix HTML structure
                html = html.replace(/<p>\s*<\/p>/g, '');
                html = html.replace(/<p>\s*(<h[1-6]>)/g, '$1');
                html = html.replace(/(<\/h[1-6]>)\s*<\/p>/g, '$1');
                html = html.replace(/<p>\s*(<ul>)/g, '$1');
                html = html.replace(/(<\/ul>)\s*<\/p>/g, '$1');
                html = html.replace(/<p>\s*(<ol>)/g, '$1');
                html = html.replace(/(<\/ol>)\s*<\/p>/g, '$1');
                html = html.replace(/<p>\s*(<table>)/g, '$1');
                html = html.replace(/(<\/table>)\s*<\/p>/g, '$1');
                
                return html;
            }

            parseTemplates(text) {
                // Parse {{infobox IPA|...}} templates
                text = text.replace(/\{\{infobox IPA\|(.*?)\}\}/gi, (match, params) => {
                    return this.renderIPAInfobox(params);
                });
                
                // Parse {{features|...}} templates
                text = text.replace(/\{\{features\|(.*?)\}\}/gi, (match, params) => {
                    return this.renderFeatures(params);
                });
                
                return text;
            }

            renderIPAInfobox(params) {
                const paramPairs = params.split('|');
                const data = {};
                
                paramPairs.forEach(pair => {
                    const [key, value] = pair.split('=').map(s => s.trim());
                    if (key && value) {
                        data[key] = value;
                    }
                });
                
                let symbols = [];
                if (data['ipa symbol']) symbols.push(data['ipa symbol']);
                if (data['ipa symbol2']) symbols.push(data['ipa symbol2']);
                if (data['ipa symbol3']) symbols.push(data['ipa symbol3']);
                if (data['ipa symbol4']) symbols.push(data['ipa symbol4']);
                
                let html = '<table class="infobox">';
                
                // Title row
                if (data.above) {
                    html += `<tr><th>${data.above}</th></tr>`;
                }
                
                // Symbol rows
                symbols.forEach(symbol => {
                    html += `<tr><td><span class="IPA-symbol">${symbol}</span></td></tr>`;
                });
                
                // Audio row
                if (data.soundfile) {
                    html += `<tr><td class="audio-row">
                        <button class="audio-button" onclick="alert('Audio: ${data.soundfile}')">ðŸ”Š Play</button>
                    </td></tr>`;
                }
                
                html += '</table>';
                return html;
            }

            renderFeatures(params) {
                const features = params.split('|').map(f => f.trim()).filter(f => f);
                
                let html = '<div class="features-list"><ul>';
                features.forEach(feature => {
                    html += `<li><strong>Manner:</strong> ${feature}</li>`;
                });
                html += '</ul></div>';
                
                return html;
            }
        }

        // Initialize the wiki
        const wiki = new Wiki();
    </script>
</body>
</html>
