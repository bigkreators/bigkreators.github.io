<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteWebsite</title>
    <style>
        :root {
            /* Light mode variables */
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-main: rgba(255, 255, 255, 0.95);
            --bg-section: rgba(255, 255, 255, 0.7);
            --bg-input: rgba(255, 255, 255, 0.9);
            --bg-light: rgba(255, 255, 255, 0.5);
            --bg-lighter: rgba(255, 255, 255, 0.6);
            --bg-item: rgba(255, 255, 255, 0.8);
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --text-light: #555;
            --border-color: #e0e0e0;
            --border-light: #ddd;
            --accent-gradient: linear-gradient(45deg, #667eea, #764ba2);
            --accent-blue: #667eea;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            /* Dark mode variables */
            --bg-gradient: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            --bg-main: rgba(45, 45, 45, 0.95);
            --bg-section: rgba(60, 60, 60, 0.7);
            --bg-input: rgba(70, 70, 70, 0.9);
            --bg-light: rgba(80, 80, 80, 0.5);
            --bg-lighter: rgba(85, 85, 85, 0.6);
            --bg-item: rgba(70, 70, 70, 0.8);
            --text-primary: #f0f0f0;
            --text-secondary: #ccc;
            --text-muted: #aaa;
            --text-light: #bbb;
            --border-color: #555;
            --border-light: #666;
            --accent-gradient: linear-gradient(45deg, #4a5bc4, #5d3b85);
            --accent-blue: #4a5bc4;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-main);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px var(--shadow);
        }

        .container > p {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 30px;
            font-size: 2.5em;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .theme-toggle {
            display: block;
            margin: 0 auto 30px auto;
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            text-transform: uppercase;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .input-section {
            margin-bottom: 40px;
            padding: 25px;
            background: var(--bg-section);
            border-radius: 15px;
            border: 2px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 1.1em;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            margin: 0 5px;
        }

        .btn-delete {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .btn-edit {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .saved-items {
            margin-top: 30px;
        }

        .saved-items h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .saved-items h2 #noteCount {
            font-size: 0.7em;
            color: var(--text-muted);
            font-weight: normal;
        }

        .item {
            background: var(--bg-item);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--shadow);
        }

        .item-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .item-content {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .item-date {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .no-items {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 40px;
        }

        .edit-form {
            background: var(--bg-input);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .edit-form input, .edit-form textarea {
            margin-bottom: 15px;
        }

        .font-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px 10px;
            background: var(--bg-lighter);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .font-selector label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            margin: 0;
        }

        .font-selector select, .font-selector input {
            padding: 6px 10px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .font-selector select {
            min-width: 140px;
        }

        .font-selector input {
            min-width: 120px;
            display: none;
        }

        .font-selector input.show {
            display: block;
        }

        .folder-section {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px 10px;
            background: var(--bg-lighter);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .folder-section label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            margin: 0;
        }

        .folder-section select, .folder-section input {
            padding: 6px 10px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .folder-section select {
            min-width: 120px;
        }

        .folder-section input {
            min-width: 120px;
            display: none;
        }

        .folder-section input.show {
            display: block;
        }

        .folder-section .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0 0 0 5px;
        }

        .folder-header {
            background: var(--bg-lighter);
            padding: 10px 15px;
            margin: 20px 0 10px 0;
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
        }

        .folder-header h3 {
            color: var(--accent-blue);
            font-size: 1.2em;
            margin: 0;
        }

        .folder-filter {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-lighter);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .folder-filter-top {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-filter label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            margin: 0;
        }

        .folder-filter select {
            padding: 8px 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            min-width: 150px;
        }

        .folder-management {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-section);
            border-radius: 15px;
            border: 2px solid var(--border-color);
        }

        .folder-management h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .folder-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .folder-controls input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            min-width: 200px;
        }

        .folder-controls input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .folder-list {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 100%;
            overflow: hidden;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            background: var(--bg-lighter);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            max-width: 200px;
            word-break: break-word;
        }

        .folder-item span {
            font-size: 14px;
            color: var(--accent-blue);
            font-weight: 500;
        }

        .folder-delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .folder-delete-btn:hover {
            background: #ee5a52;
        }

        .pin-btn {
            background: #ffd700;
            color: #333;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-right: 5px;
        }

        .pin-btn:hover {
            background: #ffed4a;
        }

        .pin-btn.pinned {
            background: #ff6b6b;
            color: white;
        }

        .pinned-item {
            border-left: 4px solid #ffd700 !important;
            background: rgba(255, 215, 0, 0.1) !important;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .sort-controls select {
            padding: 6px 10px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .word-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: right;
        }

        .auto-save-indicator {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 5px;
            text-align: right;
        }

        .hidden-folder-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            color: #856404;
            margin-bottom: 10px;
        }

        .formatting-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-light);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .format-btn {
            background: var(--bg-item);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 35px;
            text-align: center;
            color: var(--text-primary);
        }

        .format-btn:hover {
            background: var(--bg-lighter);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .format-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .item-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📝 NoteWebsite</h1>
        <button class="theme-toggle" id="themeToggle">Dark Mode</button>
        <p>You can save notes in text here privately without anyone seeing it, unless you share it. Please note that if you clear your browser, you'll lose your notes.</p>
        
        <div class="folder-management">
            <h3>📁 Create folders</h3>
            <div class="folder-controls">
                <input type="text" id="folderNameInput" placeholder="Enter new folder name...">
                <button type="button" class="btn btn-small" onclick="createNewFolder()">Create Folder</button>
            </div>
        </div>

        <div class="input-section">
            <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" id="title" placeholder="Enter a title for your note...">
            </div>

            <div class="folder-section">
                <label for="folderSelect">Folder:</label>
                <select id="folderSelect">
                    <option value="">None</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="content">Content:</label>
                <div class="font-selector">
                    <label for="fontSelect">Font:</label>
                    <select id="fontSelect" onchange="handleFontChange()">
                        <option value="inherit">Default</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Helvetica, sans-serif">Helvetica</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="other">Other...</option>
                    </select>
                    <input type="text" id="customFont" placeholder="Enter font name..." onchange="applyCustomFont()">
                </div>
                <div class="formatting-toolbar">
                    <button type="button" class="format-btn" onclick="applyFormat('**', '**')" title="Bold">B</button>
                    <button type="button" class="format-btn" onclick="applyFormat('*', '*')" title="Italic"><i>I</i></button>
                    <button type="button" class="format-btn" onclick="applyFormat('~~', '~~')" title="Strikethrough"><s>S</s></button>
                    <button type="button" class="format-btn" onclick="applyFormat('`', '`')" title="Code">&lt;/&gt;</button>
                    <button type="button" class="format-btn" onclick="insertLink()" title="Link">🔗</button>
                    <button type="button" class="format-btn" onclick="insertList()" title="Bullet List">•</button>
                </div>
                <textarea id="content" placeholder="Write your note here..."></textarea>
                <div class="word-count" id="wordCount">0 characters; 0 words</div>
                <div class="auto-save-indicator" id="autoSaveIndicator"></div>
            </div>
            
            <button class="btn" id="saveBtn">Save note</button>
        </div>
        
        <div class="saved-items">
            <h2>Saved notes <span id="noteCount">(0)</span></h2>
            <div class="folder-filter">
                <div class="folder-filter-top">
                    <label for="viewFolderSelect">View folder:</label>
                    <select id="viewFolderSelect" onchange="displayItems()">
                        <option value="">All folders</option>
                    </select>
                </div>
                <div class="sort-controls">
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect" onchange="displayItems()">
                        <option value="date-desc">Newest first</option>
                        <option value="date-asc">Oldest first</option>
                        <option value="edited-desc">Last edited</option>
                        <option value="alpha-asc">A to Z</option>
                        <option value="alpha-desc">Z to A</option>
                        <option value="this-year">This year</option>
                        <option value="this-month">This month</option>
                        <option value="this-week">This week</option>
                    </select>
                </div>
                <div class="folder-list" id="folderList"></div>
            </div>
            <div id="itemsList"></div>
        </div>
    </div>

    <script>
        // Storage keys for localStorage
        const STORAGE_KEY = 'textStorageApp';
        const FOLDERS_KEY = 'textStorageAppFolders';
        const DRAFT_KEY = 'textStorageAppDraft';
        const DEFAULTS_CREATED_KEY = 'textStorageAppDefaultsCreated';
        
        // Auto-save variables
        let autoSaveTimeout;
        let lastSavedDraft = '';
        
        // Get DOM elements
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const saveBtn = document.getElementById('saveBtn');
        const itemsList = document.getElementById('itemsList');
        const wordCountEl = document.getElementById('wordCount');
        const autoSaveIndicator = document.getElementById('autoSaveIndicator');
        
        // Load saved items on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFolders();
            displayItems();
            loadDraft();
            updateWordCount();
            loadTheme();
            
            // Add event listener for theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        });
        
        // Save button event listener
        saveBtn.addEventListener('click', function() {
            const title = titleInput.value.trim() || 'Untitled';
            const content = contentInput.value.trim();
            
            if (!content) {
                alert('Please add some content to your note!');
                return;
            }
            
            saveItem(title, content);
            titleInput.value = '';
            contentInput.value = '';
            // Reset font selector and textarea font
            document.getElementById('fontSelect').value = 'inherit';
            document.getElementById('content').style.fontFamily = 'inherit';
            document.getElementById('customFont').classList.remove('show');
            document.getElementById('customFont').value = '';
            // Reset folder selector to default
            document.getElementById('folderSelect').value = 'Meeting Notes';
            // Reset word count
            updateWordCount();
            displayItems();
        });
        
        // Save item to localStorage
        function saveItem(title, content) {
            const items = getItems();
            const textarea = document.getElementById('content');
            const folderSelect = document.getElementById('folderSelect');
            
            // Get the current font family from the textarea
            let fontFamily = textarea.style.fontFamily;
            
            // If no font is set, use 'inherit'
            if (!fontFamily || fontFamily === '') {
                fontFamily = 'inherit';
            }
            
            // Ensure a folder is selected (default to first option if none selected)
            let selectedFolder = folderSelect.value;
            if (!selectedFolder) {
                selectedFolder = 'Meeting Notes'; // Default to first folder
            }
            
            console.log('Saving font:', fontFamily); // Debug log
            
            const newItem = {
                id: Date.now(),
                title: title,
                content: content,
                font: fontFamily,
                folder: selectedFolder,
                date: new Date().toLocaleString(),
                dateCreated: new Date().toISOString(),
                dateEdited: new Date().toISOString(),
                pinned: false,
                hidden: false
            };
            
            items.push(newItem);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
            
            // Clear draft after successful save
            clearDraft();
        }
        
        // Get all items from localStorage
        function getItems() {
            const items = localStorage.getItem(STORAGE_KEY);
            return items ? JSON.parse(items) : [];
        }

        // Folder management functions
        function getFolders() {
            const folders = localStorage.getItem(FOLDERS_KEY);
            return folders ? JSON.parse(folders) : [];
        }

        function saveFolders(folders) {
            localStorage.setItem(FOLDERS_KEY, JSON.stringify(folders));
        }

        function loadFolders() {
            const folders = getFolders();
            const folderSelect = document.getElementById('folderSelect');
            const viewFolderSelect = document.getElementById('viewFolderSelect');
            
            // Clear existing options and add default folders (no "None" option)
            folderSelect.innerHTML = `
                <option value="Meeting Notes">Meeting Notes</option>
                <option value="To-Do Lists">To-Do Lists</option>
                <option value="Ideas">Ideas</option>
                <option value="Daily Journal">Daily Journal</option>
            `;
            
            viewFolderSelect.innerHTML = `
                <option value="">All folders</option>
                <option value="Hidden">Hidden</option>
                <option value="Meeting Notes">Meeting Notes</option>
                <option value="To-Do Lists">To-Do Lists</option>
                <option value="Ideas">Ideas</option>
                <option value="Daily Journal">Daily Journal</option>
            `;

            // Add custom folder options to both selectors
            const defaultFolders = ['Meeting Notes', 'To-Do Lists', 'Ideas', 'Daily Journal'];
            folders.forEach(folder => {
                if (!defaultFolders.includes(folder)) { // Only add non-default folders
                    // Add to create note selector
                    const option1 = document.createElement('option');
                    option1.value = folder;
                    option1.textContent = folder;
                    folderSelect.appendChild(option1);
                    
                    // Add to view filter selector
                    const option2 = document.createElement('option');
                    option2.value = folder;
                    option2.textContent = folder;
                    viewFolderSelect.appendChild(option2);
                }
            });
            
            // Remove the "None" option from view filter since all notes now have folders
            // (keeping this commented out - we don't need "Unfiled Notes" anymore)
            
            // Update folder list display
            updateFolderList();
        }

        function updateFolderList() {
            const folders = getFolders();
            const folderList = document.getElementById('folderList');
            const defaultFolders = ['Meeting Notes', 'To-Do Lists', 'Ideas', 'Daily Journal'];
            
            // Only show custom folders (non-default folders)
            const customFolders = folders.filter(f => !defaultFolders.includes(f));
            
            if (customFolders.length === 0) {
                folderList.innerHTML = '<p style="color: #666; font-style: italic; margin: 10px 0;">No custom folders created yet.</p>';
                return;
            }
            
            folderList.innerHTML = customFolders.map(folder => {
                return `
                    <div class="folder-item">
                        <span>${escapeHtml(folder)}</span>
                        <button class="folder-delete-btn" onclick="deleteFolder('${escapeHtml(folder)}')" title="Delete folder">×</button>
                    </div>
                `;
            }).join('');
        }

        // Pin/Hide functionality
        function togglePin(id) {
            const items = getItems();
            const itemIndex = items.findIndex(item => item.id === id);
            
            if (itemIndex !== -1) {
                items[itemIndex].pinned = !items[itemIndex].pinned;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                displayItems();
            }
        }

        function toggleHide(id) {
            const items = getItems();
            const itemIndex = items.findIndex(item => item.id === id);
            
            if (itemIndex !== -1) {
                items[itemIndex].hidden = !items[itemIndex].hidden;
                if (items[itemIndex].hidden) {
                    items[itemIndex].folder = 'Hidden'; // Move to Hidden folder
                } else {
                    items[itemIndex].folder = null; // Move back to unfiled
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                displayItems();
            }
        }

        function createNewFolder() {
            const folderNameInput = document.getElementById('folderNameInput');
            const folderName = folderNameInput.value.trim();
            const defaultFolders = ['Meeting Notes', 'To-Do Lists', 'Ideas', 'Daily Journal'];
            
            if (!folderName) {
                alert('Please enter a folder name!');
                return;
            }
            
            // Check if it's a default folder name
            if (defaultFolders.includes(folderName)) {
                alert('This folder already exists as a default folder!');
                return;
            }
            
            const folders = getFolders();
            if (folders.includes(folderName)) {
                alert('A folder with this name already exists!');
                return;
            }
            
            folders.push(folderName);
            folders.sort(); // Keep folders alphabetically sorted
            saveFolders(folders);
            loadFolders();
            
            // Clear input
            folderNameInput.value = '';
        }

        function deleteFolder(folderName) {
            const defaultFolders = ['Meeting Notes', 'To-Do Lists', 'Ideas', 'Daily Journal'];
            
            // Prevent deletion of default folders
            if (defaultFolders.includes(folderName)) {
                alert('Default folders cannot be deleted!');
                return;
            }
            
            // Check if folder has notes
            const items = getItems();
            const notesInFolder = items.filter(item => item.folder === folderName);
            
            let confirmMessage = `Are you sure you want to delete the folder "${folderName}"?`;
            if (notesInFolder.length > 0) {
                confirmMessage += `\n\nThis folder contains ${notesInFolder.length} note(s). These notes will be moved to "Unfiled Notes".`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Remove folder from folders list
            const folders = getFolders();
            const updatedFolders = folders.filter(folder => folder !== folderName);
            saveFolders(updatedFolders);
            
            // Move notes to unfiled (remove folder property)
            if (notesInFolder.length > 0) {
                const allItems = getItems();
                allItems.forEach(item => {
                    if (item.folder === folderName) {
                        delete item.folder;
                    }
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allItems));
            }
            
            // Refresh everything
            loadFolders();
            displayItems();
        }

        function handleFolderChange() {
            // This function can be used later if needed for special folder selection logic
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Simple markdown renderer
        function renderMarkdown(text) {
            // First escape HTML to prevent XSS
            let html = escapeHtml(text);
            
            // Apply markdown formatting
            html = html
                // Bold: **text** or __text__
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                // Italic: *text* or _text_
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                // Strikethrough: ~~text~~
                .replace(/~~(.*?)~~/g, '<del>$1</del>')
                // Code: `text`
                .replace(/`(.*?)`/g, '<code style="background: rgba(0,0,0,0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                // Links: [text](url)
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: none;">$1</a>')
                // Bullet lists: lines starting with •
                .replace(/^• (.+)$/gm, '<li style="margin-left: 20px;">$1</li>')
                // Line breaks
                .replace(/\n/g, '<br>');
                
            return html;
        }
        
        // Display all saved items
        function displayItems() {
            const items = getItems();
            const viewFolderSelect = document.getElementById('viewFolderSelect');
            const sortSelect = document.getElementById('sortSelect');
            const noteCountEl = document.getElementById('noteCount');
            const selectedFolder = viewFolderSelect.value;
            const sortBy = sortSelect.value;
            
            // Update note count
            noteCountEl.textContent = `(${items.length})`;
            
            if (items.length === 0) {
                itemsList.innerHTML = '<div class="no-items">No saved notes yet. Start by writing some notes above!</div>';
                return;
            }
            
            // Filter items based on selected folder
            let filteredItems = items;
            if (selectedFolder !== '') {
                if (selectedFolder === 'Hidden') {
                    // Show only hidden notes
                    filteredItems = items.filter(item => item.hidden || item.folder === 'Hidden');
                } else {
                    // Show only notes in the selected folder
                    filteredItems = items.filter(item => item.folder === selectedFolder);
                }
            } else {
                // Show all notes except hidden ones when viewing all folders
                filteredItems = items.filter(item => !item.hidden && item.folder !== 'Hidden');
            }
            
            // Apply sorting
            filteredItems = sortItems(filteredItems, sortBy);
            
            if (filteredItems.length === 0) {
                const folderName = selectedFolder === 'Hidden' ? 'Hidden' : selectedFolder || 'All folders';
                itemsList.innerHTML = `<div class="no-items">No notes in "${folderName}" yet.</div>`;
                return;
            }
            
            // Show Hidden folder notice
            if (selectedFolder === 'Hidden') {
                itemsList.innerHTML = '<div class="hidden-folder-notice">📁 Hidden Notes - These notes are archived and hidden from the main view.</div>';
            } else {
                itemsList.innerHTML = '';
            }
            
            // Separate pinned and regular items
            const pinnedItems = filteredItems.filter(item => item.pinned);
            const regularItems = filteredItems.filter(item => !item.pinned);
            
            // Group items by folder (only if showing all folders and not sorting by time periods)
            if (selectedFolder === '' && !['this-year', 'this-month', 'this-week'].includes(sortBy)) {
                // Group regular items by folder
                const itemsByFolder = {};
                regularItems.forEach(item => {
                    const folder = item.folder || 'Other'; // Fallback for any items without folders
                    if (!itemsByFolder[folder]) {
                        itemsByFolder[folder] = [];
                    }
                    itemsByFolder[folder].push(item);
                });
                
                // Sort folders alphabetically
                const sortedFolders = Object.keys(itemsByFolder).sort();
                
                let html = itemsList.innerHTML;
                
                // Add pinned items first
                if (pinnedItems.length > 0) {
                    html += '<div class="folder-header"><h3>📌 Pinned Notes</h3></div>';
                    pinnedItems.forEach(item => {
                        html += generateItemHTML(item);
                    });
                }
                
                // Add regular items grouped by folder
                sortedFolders.forEach(folder => {
                    if (itemsByFolder[folder].length > 0) {
                        if (sortedFolders.length > 1 || pinnedItems.length > 0) {
                            html += `<div class="folder-header"><h3>${folder}</h3></div>`;
                        }
                        
                        itemsByFolder[folder].forEach(item => {
                            html += generateItemHTML(item);
                        });
                    }
                });
                
                itemsList.innerHTML = html;
            } else {
                // Show filtered items without folder headers
                let html = itemsList.innerHTML;
                
                // Add pinned items first
                if (pinnedItems.length > 0) {
                    html += '<div class="folder-header"><h3>📌 Pinned Notes</h3></div>';
                    pinnedItems.forEach(item => {
                        html += generateItemHTML(item);
                    });
                }
                
                // Add regular items
                if (regularItems.length > 0 && pinnedItems.length > 0) {
                    html += '<div class="folder-header"><h3>Other Notes</h3></div>';
                }
                
                regularItems.forEach(item => {
                    html += generateItemHTML(item);
                });
                
                itemsList.innerHTML = html;
            }
        }

        // Helper function to generate HTML for a single item
        function generateItemHTML(item) {
            console.log('Displaying note with font:', item.font); // Debug log
            // Escape quotes in font family for HTML attribute
            const escapedFont = (item.font || 'inherit').replace(/"/g, '&quot;');
            const isPinned = item.pinned || false;
            const isHidden = item.hidden || false;
            
            return `
            <div class="item ${isPinned ? 'pinned-item' : ''}" data-id="${item.id}">
                <div class="item-date">${item.date}</div>
                <div class="item-title">${escapeHtml(item.title)}</div>
                <div class="item-content" style="font-family: ${escapedFont};">${renderMarkdown(item.content)}</div>
                <div class="item-actions">
                    <button class="btn btn-small pin-btn ${isPinned ? 'pinned' : ''}" onclick="togglePin(${item.id})" title="${isPinned ? 'Unpin' : 'Pin'} note">
                        ${isPinned ? '📌' : '📍'}
                    </button>
                    <button class="btn btn-small ${isHidden ? 'btn-edit' : 'btn-delete'}" onclick="toggleHide(${item.id})" title="${isHidden ? 'Unhide' : 'Hide'} note">
                        ${isHidden ? 'Show' : 'Hide'}
                    </button>
                    <button class="btn btn-small btn-edit" onclick="editItem(${item.id})">Edit</button>
                    <button class="btn btn-small btn-delete" onclick="deleteItem(${item.id})">Delete</button>
                </div>
            </div>
            `;
        }

        // Sorting functions
        function sortItems(items, sortBy) {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            
            switch (sortBy) {
                case 'date-desc':
                    return items.sort((a, b) => new Date(b.dateCreated || b.date) - new Date(a.dateCreated || a.date));
                case 'date-asc':
                    return items.sort((a, b) => new Date(a.dateCreated || a.date) - new Date(b.dateCreated || b.date));
                case 'edited-desc':
                    return items.sort((a, b) => new Date(b.dateEdited || b.date) - new Date(a.dateEdited || a.date));
                case 'alpha-asc':
                    return items.sort((a, b) => a.title.toLowerCase().localeCompare(b.title.toLowerCase()));
                case 'alpha-desc':
                    return items.sort((a, b) => b.title.toLowerCase().localeCompare(a.title.toLowerCase()));
                case 'this-year':
                    return items.filter(item => new Date(item.dateCreated || item.date) >= startOfYear)
                                .sort((a, b) => new Date(b.dateCreated || b.date) - new Date(a.dateCreated || a.date));
                case 'this-month':
                    return items.filter(item => new Date(item.dateCreated || item.date) >= startOfMonth)
                                .sort((a, b) => new Date(b.dateCreated || b.date) - new Date(a.dateCreated || a.date));
                case 'this-week':
                    return items.filter(item => new Date(item.dateCreated || item.date) >= startOfWeek)
                                .sort((a, b) => new Date(b.dateCreated || b.date) - new Date(a.dateCreated || a.date));
                default:
                    return items;
            }
        }
        
        // Store original content for cancel functionality
        let editingStates = {};
        
        // Edit item
        function editItem(id) {
            const items = getItems();
            const item = items.find(item => item.id === id);
            
            if (!item) return;
            
            // Store the original item data
            editingStates[id] = {
                title: item.title,
                content: item.content,
                date: item.date
            };
            
            const itemElement = document.querySelector(`[data-id="${id}"]`);
            
            itemElement.innerHTML = `
                <div class="edit-form">
                    <input type="text" id="editTitle${id}" value="${escapeHtml(item.title)}" placeholder="Title">
                    <textarea id="editContent${id}" placeholder="Content">${escapeHtml(item.content)}</textarea>
                    <button class="btn btn-small" onclick="saveEdit(${id})">Save</button>
                    <button class="btn btn-small btn-delete" onclick="cancelEdit(${id})">Cancel</button>
                </div>
            `;
        }
        
        // Save edited item
        function saveEdit(id) {
            const newTitle = document.getElementById(`editTitle${id}`).value.trim() || 'Untitled';
            const newContent = document.getElementById(`editContent${id}`).value.trim();
            
            if (!newContent) {
                alert('Please add some content to your note!');
                return;
            }
            
            const items = getItems();
            const itemIndex = items.findIndex(item => item.id === id);
            
            if (itemIndex !== -1) {
                items[itemIndex].title = newTitle;
                items[itemIndex].content = newContent;
                items[itemIndex].date = new Date().toLocaleString() + ' (edited)';
                items[itemIndex].dateEdited = new Date().toISOString();
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                delete editingStates[id]; // Clean up
                displayItems();
            }
        }
        
        // Cancel edit
        function cancelEdit(id) {
            delete editingStates[id]; // Clean up
            displayItems(); // Just refresh the display to restore original content
        }
        
        // Delete item
        function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            
            const items = getItems();
            const filteredItems = items.filter(item => item.id !== id);
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredItems));
            displayItems();
        }
        
        // Allow Enter key to save (Ctrl+Enter in textarea)
        titleInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveBtn.click();
            }
        });
        
        contentInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                saveBtn.click();
            }
        });

        // Word count and auto-save functionality
        titleInput.addEventListener('input', function() {
            scheduleAutoSave();
        });

        contentInput.addEventListener('input', function() {
            updateWordCount();
            scheduleAutoSave();
        });

        function updateWordCount() {
            const content = contentInput.value;
            
            const charCount = content.length;
            const wordCount = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;
            
            wordCountEl.textContent = `${charCount} characters; ${wordCount} words`;
        }

        // Auto-save draft functionality
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(saveDraft, 3000); // Save after 3 seconds of inactivity
        }

        function saveDraft() {
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            
            if (!title && !content) {
                clearDraft();
                return;
            }
            
            const currentDraft = JSON.stringify({title, content});
            if (currentDraft !== lastSavedDraft) {
                localStorage.setItem(DRAFT_KEY, currentDraft);
                lastSavedDraft = currentDraft;
                autoSaveIndicator.textContent = 'Draft saved';
                setTimeout(() => {
                    autoSaveIndicator.textContent = '';
                }, 2000);
            }
        }

        function loadDraft() {
            const draft = localStorage.getItem(DRAFT_KEY);
            if (draft) {
                try {
                    const {title, content} = JSON.parse(draft);
                    if (title || content) {
                        titleInput.value = title;
                        contentInput.value = content;
                        lastSavedDraft = draft;
                        autoSaveIndicator.textContent = 'Draft loaded';
                        setTimeout(() => {
                            autoSaveIndicator.textContent = '';
                        }, 2000);
                    }
                } catch (e) {
                    // Invalid draft data, clear it
                    clearDraft();
                }
            }
        }

        function clearDraft() {
            localStorage.removeItem(DRAFT_KEY);
            lastSavedDraft = '';
            autoSaveIndicator.textContent = '';
        }

        // Allow Enter key to create folder
        document.getElementById('folderNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createNewFolder();
            }
        });

        // Formatting functions
        function applyFormat(startTag, endTag) {
            const textarea = document.getElementById('content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let replacement;
            if (selectedText) {
                // If text is selected, wrap it
                replacement = startTag + selectedText + endTag;
            } else {
                // If no text selected, insert tags with placeholder
                replacement = startTag + 'text' + endTag;
            }
            
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            
            // Position cursor
            if (selectedText) {
                textarea.setSelectionRange(start, start + replacement.length);
            } else {
                textarea.setSelectionRange(start + startTag.length, start + startTag.length + 4); // Select 'text'
            }
            
            textarea.focus();
        }

        function insertLink() {
            const textarea = document.getElementById('content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            const linkText = selectedText || 'link text';
            const replacement = `[${linkText}](url)`;
            
            textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            
            // Position cursor at 'url' part
            const urlStart = start + linkText.length + 3; // Position after ']('
            textarea.setSelectionRange(urlStart, urlStart + 3); // Select 'url'
            textarea.focus();
        }

        function insertList() {
            const textarea = document.getElementById('content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            // Find the start of the current line
            const beforeCursor = textarea.value.substring(0, start);
            const lineStart = beforeCursor.lastIndexOf('\n') + 1;
            
            const replacement = '• ';
            
            // Insert bullet at the beginning of the line or current position
            if (lineStart === start || textarea.value.substring(lineStart, start).trim() === '') {
                // At beginning of line or line is empty
                textarea.value = textarea.value.substring(0, lineStart) + replacement + textarea.value.substring(start);
                textarea.setSelectionRange(lineStart + replacement.length, lineStart + replacement.length);
            } else {
                // Insert new line with bullet
                const newLine = '\n' + replacement;
                textarea.value = textarea.value.substring(0, start) + newLine + textarea.value.substring(end);
                textarea.setSelectionRange(start + newLine.length, start + newLine.length);
            }
            
            textarea.focus();
        }

        // Font handling functions
        function handleFontChange() {
            const fontSelect = document.getElementById('fontSelect');
            const customFontInput = document.getElementById('customFont');
            const textarea = document.getElementById('content');
            
            if (fontSelect.value === 'other') {
                customFontInput.classList.add('show');
                customFontInput.focus();
            } else {
                customFontInput.classList.remove('show');
                customFontInput.value = '';
                textarea.style.fontFamily = fontSelect.value;
            }
        }

        function applyCustomFont() {
            const customFontInput = document.getElementById('customFont');
            const textarea = document.getElementById('content');
            const fontName = customFontInput.value.trim();
            
            if (fontName) {
                // Just use the font name as entered, don't force sans-serif
                const formattedFont = fontName.includes(' ') ? `'${fontName}'` : fontName;
                textarea.style.fontFamily = formattedFont;
            }
        }

        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeToggle.textContent = 'Dark Mode';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = 'Light Mode';
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = 'Light Mode';
            } else {
                themeToggle.textContent = 'Dark Mode';
            }
        }
    </script>
</body>
</html>
